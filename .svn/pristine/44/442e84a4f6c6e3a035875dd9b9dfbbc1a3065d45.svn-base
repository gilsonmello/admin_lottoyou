<?php
/**
 * CakePHP Permissions
 * @author Gustavo Cardoso
 */
class PermissionsController extends AppController  {
    
    public $components = array('ControllerList');
    
    public function index() {
        // INICIALIZA VARIÁVEIS
        $semVinculoComFuncionalidade = array();
        $adicionar = 0;
        $remover = 0;

        // CONFIGURA O MODEL
        $this->Permission->recursive = 0;

        // PEGA PERMISSÕES CADASTRADAS
        $database_permissions = $this->Permission->find('all');

        // CALCULA O TOTAL DE PERMISSÕES CADASTRADAS
        $total = count($database_permissions);
        
        // PEGA PERMISSÕES DISPONÍVEIS
        $controller_permissions = $this->ControllerList->get();

        // PREPARA PERMISSÕES DISPONÍVEIS
        $aux = array();
        foreach($controller_permissions as $k => $v){
            foreach($v as $m){
                $aux[] = $k.'.'.$m;
            }
        }
        $controller_permissions = $aux;
        
        // VERIFICA SE A PERMISSÃO EXISTE NO CONTROLLER
        foreach($database_permissions as $k => $v){
            if ($v['Permission']['totalFuncionalidades'] == 0){
                $semVinculoComFuncionalidade[] = $database_permissions[$k]['Permission']['name'];
            }
        }

        // PREPARA PERMISSÕES CADASTRADAS
        $aux = array();
        foreach($database_permissions as $k => $v){
            $aux[] = $v['Permission']['name'];
        }
        $database_permissions = $aux;
        
        $remover = array_diff($database_permissions, $controller_permissions);
        $adicionar = array_diff($controller_permissions, $database_permissions);

        // ENVIA PARA A VIEW O TOTAL DE PERMISSÕES A ADICIONAR
        return compact('adicionar','remover','semVinculoComFuncionalidade','total');
	}
    
    public function add(){
        // PEGA DADOS
        $dados = $this->index();

        // INICIARLIZA VARIÁVEIS
        $adicionar = $dados['adicionar'];
        $remover = $dados['remover'];

        // VERFICA SE EXISTEM PERMISSÕES A CADASTRAR
        if (count($adicionar)){
            $permissions = array(); foreach ($adicionar as $v) $permissions[]['name'] = $v;
            $this->Permission->saveAll($permissions);
        }
        
        // VERFICA SE EXISTEM PERMISSÕES A DELETAR
        if (count($remover)){
            $this->Permission->deleteAll(array('name'=>$remover));
        }

        // ENVIA DADOS PARA A VIEW 
        $this->set(compact('adicionar','remover'));
    }
}
