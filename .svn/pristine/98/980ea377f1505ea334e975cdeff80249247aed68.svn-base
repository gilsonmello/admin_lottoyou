<section id="AppUpdates">
    <div class="section-body">
        <div class="card-head card-head-sm style-primary">
            <header>
                <i class="md md-publish" style="vertical-align: inherit;  margin-top: -0.3em;"></i> 
                Deploy
            </header>
            <div class="tools">
                <button id="atualizar" type="button" class="btn ink-reaction btn-default-light">
                    <i class="md-refresh"></i>
                    Atualizar
                </button>
            </div>
        </div>

        <div class="card card-collapsed">
            <div class="card-head card-head-sm" style="border-bottom:1px solid #f2f3f3;">
                <header class="" style="font-weight:normal;text-transform:none;">
                    <i class="md md-info text-info" style="vertical-align: inherit;margin-top: -0.3em;"></i> 
                    Ferramenta criada para auxiliar a publicação de manutenções para o ambiente de produção
                </header>
            </div>

            <div id="gridVenPedido" style="padding: 24px;">
                <!-- MENSAGEM -->
                <?php echo $this->Session->flash(); ?>
            
                <!-- PASSO 1 -->
                <div class="row form-config" style="margin-bottom:10px;<?php if ($config){ ?>display:none;<?php } ?>">
                    <div class="col-md-12">
                        <div class="alert alert-callout alert-info" role="alert">
                            <h4>
                                Configure o ambiente FTP
                            </h4>
                            <hr style="margin:0 0 7px 0;"/>
                            <?php echo $this->Form->create('Environment', array('id'=>'defineConfiguration', 'class' => 'form form-validate', 'role' => 'form')); ?>

                            <div>
                                <!--div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <?php echo $this->Form->input('svn', array('label' => 'SVN','placeholder' => 'svn://.../trunk', 'class' => 'form-control')); ?>
                                        </div>
                                    </div>
                                </div-->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <?php echo $this->Form->input('host', array('label' => 'Host', 'class' => 'form-control')); ?>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <?php echo $this->Form->input('user', array('label' => 'Usuário', 'class' => 'form-control')); ?>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <?php echo $this->Form->input('pass', array('label' => 'Senha', 'class' => 'form-control')); ?>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <?php echo $this->Form->input('path', array('label' => 'Diretório', 'class' => 'form-control')); ?>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer" style="padding-right:0;padding-bottom: 0;">
                                <button type="submit" class="btn btn-primary btn-loading-state" data-loading-text="<i class='fa fa-spinner fa-spin'></i> Processando...">SALVAR</button>
                            </div>
                            <?php echo $this->Form->end(); ?>
                        </div>
                    </div>
                </div>

                <?php if ($config){ ?>
                <div class="alert alert-info form-message">
                    <h4 style="display: inline;font-weight: normal">Ambiente FTP configurado para o Host (<?php echo $this->data['Environment']['host']; ?>) para alterar <a class="alterar-config" style="font-weight: bold" href="#">clique aqui</a>.</h4>
                </div>
                <?php } ?>

                <hr/>

                <?php if(count($logs)){ ?>
                <?php $total = 0; ?>
                <?php foreach ($logs as $l) {  ?>
                <?php $total += count($l->revisoes); ?>
                <?php } ?>
                <h4 style="margin-left:5px;">Total de Revisões: <?php echo $total; ?></h4> 
                <div class="table-respon/sive">
                    <table id=""
                           class="table table-condensed table-hover" 
                           cellspacing="0" 
                           width="100%"
                           style="margin-bottom:0;">
                        <thead>
                            <tr>
                                <th style="width:90px;">Situação</th>
                                <th style="width:100px;">Revisão</th>
                                <th>Arquivo</th>
                                <th style="width:150px;" class="text-center">Total Atualizacões</th>
                                <th style="width:180px;">Data</th>
                                <th style="width:50px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($logs as $k => $log) { ?>
                            <?php foreach ($log->revisoes as $i => $r) { ?>
                                <tr class="linha">
                                    <td>
                                        <?php echo (count((@$updates[$r['cabecalho'][0]])) == count($r['arquivos'])) ? '<label class="label label-success">PUBLICADA</label>' : '<label class="label label-danger">PENDENTE</label>'; ?>
                                        <div class="log hide">
                                            <div style="margin:10px;">
                                            <table class="table table-condensed">
                                                <tr>
                                                    <th colspan="2" class="active">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="padding-top: 2px; padding-right: 9px;"><span aria-hidden="true">&times;</span></button>
                                                        Cabeçalho
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <th>Revisão</th>
                                                    <td><?php echo $r['cabecalho'][0]; ?></td>
                                                </tr>
                                                <tr>
                                                    <th>Autor</th>
                                                    <td><?php echo $r['cabecalho'][1]; ?></td>
                                                </tr>
                                                <tr>
                                                    <th>Data do Commit</th>
                                                    <td><?php echo $r['cabecalho'][2]; ?></td>
                                                </tr>
                                                <tr>
                                                    <th colspan="2" class="active">Comentários</th>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" ><?php echo str_replace(';', ';<br/>', iso_utf($r['comentarios'])); ?></td>
                                                </tr>
                                                <tr>
                                                    <th colspan="2" class="active">
                                                        Arquivos da Revisão
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <td colspan="2"><?php echo implode(';<br/>', $r['arquivos']); ?></td>
                                                </tr>
                                            </table> 
                                            </div>
                                        </div>
                                        <div class="arquivos hide">
                                            <div style="margin:10px;">
                                            <table class="table table-condensed">
                                                <tr>
                                                    <th colspan="2" class="active">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="padding-top: 2px; padding-right: 9px;"><span aria-hidden="true">&times;</span></button>
                                                        Publicar no FTP
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <td>Esta rotina tem por finalidade publicar os aquivos atualizados e commitados no SVN no ambiente FTP</td>
                                                    <td class="text-center">
                                                        <button id="<?php echo $r['cabecalho'][0]; ?>" class="btn ink-reaction btn-default-light btn-iniciar" type="button">
                                                            <i class="md md-publish"></i>
                                                            INICIAR ROTINA
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th colspan="2" class="active">
                                                        Arquivos a serem publicados
                                                    </th>
                                                </tr>
                                                <?php foreach($r['arquivos'] as $a): ?>
                                                <tr id="<?php echo $r['cabecalho'][0]; ?>" class="lista">
                                                    <td><?php echo $a; ?></td>
                                                    <td class="text-center"><i class="md md-check-box-outline-blank text-danger"></i></td>
                                                </tr>
                                                <?php endforeach; ?>
                                            </table> 
                                            </div>
                                        </div>
                                    </td>
                                    <td><?php echo $r['cabecalho']['0']; ?></td>
                                    <td><?php echo strtoupper($log->name); ?> <i id="<?php echo $i; ?>" class="md md-search ver-revisao" style="cursor:pointer;"></i></td>
                                    <td class="text-center"><?php echo count($r['arquivos']); ?></td>
                                    <td><?php echo date('d/m/Y H:i:s', $log->lastChange()); ?></td>
                                    <td>
                                        <div class="btn-group">
                                            <button data-toggle="dropdown" class="btn btn-icon-toggle dropdown-toggle" type="button"><i class="fa fa-gear"></i></button>
                                            <ul role="menu" class="dropdown-menu dropdown-menu-right">
                                                <li><a class="btn-publicar" id="3" href="javascript: void(0)"><i class="md md-publish"></i>&nbsp; Publicar</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            <?php } ?>
                            <?php } ?>
                        </tbody>
                    </table>
                </div>
                <?php } else { ?>
                <div class="card card-bordered style-default-light">
                    <div class="card-head card-head-sm ">
                        <header style="padding-left: 20px;">Não há atualizações pendentes...</header>
                    </div>
                    <div class="card-body style-default-bright show">
                        <h4>Nesta tela são exibidas atualizações pendentes de publicação. Possíveis status</h4>
                        <hr style="margin-top:10px" />
                        <dl class="dl-horizontal">
                            <dt><label class="label label-danger" style="padding-left: 7.5px; padding-right: 7.5px;">PENDENTE</label></dt>
                            <dd>Atualizações não enviadas para o ambiente de produção</dd>
                            <dt><label class="label label-success">PUBLICADA</label></dt>
                            <dd>Atualizações envadas para o ambiente de produção</dd>
                        </dl>
                    </div>
                </div>
                <?php } ?>
            </div>
        </div>
    </div>
    <script type="text/javascript"> var baseUrl = baseURL = "<?php echo $this->Html->url('/'); ?>";</script>
    <script type="text/javascript">
        $(function() {
            $('#atualizar').click(function(e){
                e.preventDefault();
                var form = $(this);
                var url = baseUrl+'sisUpdates/index/';

                $('#AppUpdates .card').html('<section><div class="section-body alert alert-callout alert-warning" role="alert"><strong>Carregando...</strong> <i class="fa fa-spinner fa-spin"></i></div></section>');
                
                $.ajax({
                    type: "GET",
                    url: url,
                    success: function(html) {
                        $('#AppUpdates').html($(html).find('#AppUpdates >'));
                    },
                    error: function() {
                        alert('Error: Operação não realizada...');
                    }
                });

                return false;
            });

            $('#defineConfiguration').submit(function(e){
                e.preventDefault();
                var form = $(this);
                var data = form.serialize();
                var url = baseUrl+'sisUpdates/index/';

                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    success: function(html) {
                        $('#AppUpdates').html($(html).find('#AppUpdates >'));
                    },
                    error: function() {
                        alert('Error: Operação não realizada...');
                    }
                });

                return false;
            });

            $('.alterar-config').click(function() {
                $('.form-message').hide();
                $('.form-config').show();
            });

            $('.ver-revisao').click(function(){
                var id = $(this).attr('id');
                var modal = $('.modal#nivel1');
                var linha = $(this).closest('.linha');
                var log = linha.find('.log').html();
                
                modal.find('.modal-dialog').css('width', '800px');
                modal.find('.modal-content').html('<section><div class="section-body alert alert-callout alert-warning" role="alert"><strong>Carregando...</strong> <i class="fa fa-spinner fa-spin"></i></div></section>');
                modal.modal('show');

                modal.find('.modal-content').html(log);
            });

            $('.btn-publicar').click(function(){
                var modal = $('.modal#nivel1');
                var linha = $(this).closest('.linha');
                var arquivos = linha.find('.arquivos').html();
                
                modal.find('.modal-dialog').css('width', '800px');
                modal.find('.modal-content').html('<section><div class="section-body alert alert-callout alert-warning" role="alert"><strong>Carregando...</strong> <i class="fa fa-spinner fa-spin"></i></div></section>');
                modal.modal('show');

                modal.find('.modal-content').html(arquivos);

                modal.find('.btn-iniciar').click(function(){
                    var modal2 = $('.modal#nivel2');
                    var btn = $(this);
                    var revision = btn.attr('id');

                    btn.attr('disabled','disabled');
                    btn.html('Processando...');
                    
                    modal2.find('.modal-dialog').css('width', '400px');
                    modal2.find('.modal-content').html('<section><div class="section-body alert alert-callout alert-warning" role="alert"><strong>Estabelecendo conexão com o FTP...</strong> <i class="fa fa-spinner fa-spin"></i></div></section>');
                    modal2.modal('show');

                    $.getJSON(baseUrl+'sisUpdates/connect', {revision:revision}, function(json, textStatus) {
                        var result = modal2.find('.modal-content section div strong');
                        if (json.error == 0){
                            result.html('Conexão com o FTP estabelecida com sucesso <i class="md md-check text-success"></i>');
                        } else {
                            result.html('Erro ao estabelecer a conexão com o FTP <i class="md md-error text-danger"></i>');
                        }

                        $('.fa-spinner').remove();

                        setTimeout(function(){
                            $('#nivel2').modal('hide');

                            if (json.error == 0){
                                // ENVIA ARQUIVOS PARA O SERVIDOR
                                transmitirArquivos(modal);

                                // DESABILITA O BOTÃO INICIAR
                                btn.html('ROTINA CONCLUÍDA');

                                // ATUALIZA LOGS
                                $('#atualizar').click();
                            }
                        }, 2000);
                    });
                });
            });

            window.materialadmin.AppVendor.initialize();
        });

        function transmitirArquivos (modal){
            var lista = modal.find('.lista');
            var revision = lista.attr('id');
            var arquivo = null;
            var check = null;

            $.ajaxSetup({async:false});

            $.each(lista, function(i, v) {
                arquivo = $(v).find('td:first').html();
                check = $(v).find('td:last');

                check.html('<i class="fa fa-spinner fa-spin"></i>');
                
                $.getJSON(baseUrl+'sisUpdates/upload', {revision:revision, arquivo: arquivo}, function(json) {
                    if (json.error == 0){
                        check.html('<i class="md md-check text-success"></i>');
                    } else {
                        check.html('<i class="md md-error text-danger"></i>');
                    }
                });
            });

            $.ajaxSetup({async:true});
        }
    </script>
</section>