<?php
App::uses('AppModel', 'Model');
/**
 * CakePHP UserModel
 * @author Go! Ponto a ponto
 */
class Permission extends AppModel {

    public $hasAndBelongsToMany = array('Funcionalidade');
    
    var $order = "Permission.name asc";
    var $displayField = "nome";
    
    public $virtualFields = array(
        'totalFuncionalidades' => "(SELECT count(1) FROM funcionalidades_permissions WHERE Permission.id = funcionalidades_permissions.permission_id)",
        'nome' => "CASE WHEN (SELECT count(1) FROM funcionalidades_permissions WHERE Permission.id = funcionalidades_permissions.permission_id) = 0 THEN CONCAT(Permission.name,'*') ELSE Permission.name END",
    );
    
    public $validate = array(
        'name' => array(
            'required' => array(
                'rule' => array('notEmpty'),
                'required' => true,
                'message' => 'Campo obrigatório'
            )
        ),
    );

    public function afterSave($created, $options = array()) {
        // VERIFICA SE FORAM PASSADAS FUNCIONALIDADES PARA VINCULAR À PERMISSÃO
        if (isset($this->data['Permission']['funcionalidade'])){
            // PREPARA DADOS
            $dados = $this->_extractFieldsHABTM($this->data['Permission']['funcionalidade'], $this->data['Permission']['id'], 'permission_id', 'funcionalidade_id');

            // APAGA REGISTROS RELACIONADOS AO ID
            $this->FuncionalidadesPermission->deleteAll(array('permission_id'=>$this->data['Permission']['id']));
            
            // ASSOCIA PERMISSÕES A FUNCIONALIDADE
            $this->FuncionalidadesPermission->saveAll($dados);
        }
        
        parent::afterSave($created, $options);
    }
    
    public function beforeSave($options = array()) {
        if (isset($this->data[$this->alias]['password'])) {
            $this->data[$this->alias]['password'] = AuthComponent::password($this->data[$this->alias]['password']);
        }
        return true;
    }
    
    public function findPermissoesNaoVinculadas(){
        return $this->find('list', array(
            'joins' => array(
                array(
                    'table' => 'funcionalidades_permissions',
                    'alias' => 'FuncionalidadesPermission',
                    'type' => 'LEFT',
                    'conditions' => array('Permission.id = FuncionalidadesPermission.permission_id')
                )
            ),
            'conditions'=>array('FuncionalidadesPermission.id IS NULL'))
        );
    }
}
